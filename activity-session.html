<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- [ClassBoard Update] 공유 메모함 (Activity Session) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=0.75, minimum-scale=0.75, user-scalable=no">
    <title>AI ClassBoard - 공유 메모보드</title>
    <link rel="stylesheet" href="main-session.css">
    <link rel="stylesheet" href="activity-session.css">
    <!-- Boxicons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <!-- Masonry -->
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="sidebar-top">
            <div class="sidebar-brand">
                <i class="bx bxs-graduation"></i>
                <span class="brand-name">세션 목록</span>
            </div>
            <button id="navbar-sidebar-toggle" class="navbar-sidebar-toggle-btn" aria-label="사이드바 토글">
                <i class="bx bx-chevron-left"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h3>수업 게시물</h3>
                <button class="btn-refresh-sessions" id="refresh-sessions" title="새로고침">
                    <i class="bx bx-refresh"></i>
                </button>
            </div>
            <div class="sessions-list" id="sessions-list">
                <!-- 세션 목록이 여기에 동적으로 추가됨 -->
            </div>
        </div>
    </aside>

    <!-- Navbar -->
    <header id="navbar">
        <div class="navbar-brand">
            <i class="bx bxs-graduation"></i>
            <span class="brand-name">ClassBoard</span>
        </div>

        <!-- 중앙 네비게이션 버튼 -->
        <div class="navbar-center">
            <button class="nav-switch-btn active" id="nav-to-activity" title="공유 메모보드 (현재 페이지)" disabled>
                <i class="bx bx-note"></i>
            </button>
            <button class="nav-switch-btn" id="nav-to-ask" title="채팅/워드클라우드로 이동">
                <i class="bx bxs-chat"></i>
            </button>
        </div>

        <div class="navbar-right">
            <label class="dark-mode-toggle">
                <input type="checkbox" id="switch-mode" aria-label="다크 모드 전환">
                <span class="switch-lm"></span>
            </label>

            <div class="profile">
                <button class="profile-btn" aria-label="프로필">
                    <i class="bx bxs-user-circle"></i>
                </button>
                <div class="profile-dropdown">
                    <div class="profile-info">
                        <div class="profile-info-header">
                            <i class="bx bxs-user-circle"></i>
                            <div>
                                <p class="profile-name" id="profile-name">관리자</p>
                                <p class="profile-role" id="profile-role">교사</p>
                            </div>
                        </div>
                    </div>
                    <div class="profile-divider"></div>
                    <a href="main-session.html" class="profile-menu-item">
                        <i class="bx bx-home"></i>
                        <span>홈으로</span>
                    </a>
                    <a href="#logout" class="profile-menu-item logout-item">
                        <i class="bx bx-log-out"></i>
                        <span>로그아웃</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="activity-session-main">
        <div class="activity-session-container">
            <!-- Activity Header -->
            <header class="activity-header">
                <div class="activity-header-left">
                    <button class="btn-back" onclick="window.history.back()">
                        <i class="bx bx-arrow-back"></i>
                    </button>
                    <div>
                        <h2 id="session-title">공유 메모보드</h2>
                        <p>수업 아이디어를 함께 정리해보세요</p>
                    </div>
                </div>
                <button class="btn-add-memo" id="addMemo">
                    <i class="bx bx-plus"></i>
                    새 메모
                </button>
            </header>

            <!-- Two Column Layout -->
            <div class="activity-content-layout">
                <!-- Left Column: Assignment Card -->
                <div class="assignment-column">
                    <div class="assignment-card">
                        <div class="assignment-card-header">
                            <h3>
                                <i class="bx bx-book-open"></i>
                                오늘의 과제
                            </h3>
                            <button class="btn-edit-assignment" id="edit-assignment-btn">
                                <i class="bx bx-edit"></i>
                            </button>
                        </div>
                        <div class="assignment-card-body" id="assignment-content">
                            <div class="assignment-empty-state" id="assignment-empty">
                                <i class="bx bx-file-blank"></i>
                                <p>과제 내용을 추가해주세요</p>
                            </div>
                            <div class="assignment-content-display" id="assignment-display" style="display: none;">
                                <div class="assignment-title" id="assignment-title"></div>
                                <div class="assignment-images" id="assignment-images"></div>
                                <div class="assignment-text" id="assignment-text"></div>
                                <div class="assignment-attachments" id="assignment-attachments"></div>
                            </div>
                        </div>
                        <div class="assignment-card-footer" id="assignment-footer" style="display: none;">
                            <div class="assignment-meta">
                                <span class="assignment-date" id="assignment-date"></span>
                                <span class="assignment-author" id="assignment-author"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Memo Board -->
                <div class="memo-column">
                    <!-- Stats & Filters -->
                    <div class="memo-stats-filters">
                        <div class="memo-stats">
                            <div class="stat-item">
                                <i class="bx bx-note"></i>
                                <span class="stat-value" id="total-memos">0</span>
                                <span class="stat-label">총 메모</span>
                            </div>
                            <div class="stat-item">
                                <i class="bx bx-user"></i>
                                <span class="stat-value" id="total-authors">0</span>
                                <span class="stat-label">작성자</span>
                            </div>
                        </div>
                        <div class="memo-filters">
                            <div class="filter-group">
                                <label>정렬:</label>
                                <select id="sort-filter" class="filter-select">
                                    <option value="newest">최신순</option>
                                    <option value="oldest">오래된순</option>
                                    <option value="author">작성자별</option>
                                </select>
                            </div>
                            <div class="search-group">
                                <i class="bx bx-search"></i>
                                <input type="text" id="memo-search" class="search-input" placeholder="메모 검색...">
                                <button class="btn-clear-search" id="clear-search" style="display: none;">
                                    <i class="bx bx-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Memo Board -->
                    <section id="memoBoard" class="memo-board">
                        <!-- 메모 카드들이 여기에 동적으로 추가됨 -->
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- 메모 작성 모달 -->
    <div class="modal-overlay" id="memo-modal" style="display: none;">
        <div class="memo-modal-content">
            <div class="modal-header">
                <h3>새 메모 작성</h3>
                <button class="modal-close" id="close-memo-modal">
                    <i class="bx bx-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="memo-title">제목 <span style="color: var(--red);">*</span></label>
                    <input type="text" id="memo-title" class="form-input" placeholder="메모 제목을 입력하세요" maxlength="50" required>
                </div>
                <div class="form-group">
                    <label for="memo-content">내용 <span style="color: var(--red);">*</span></label>
                    <textarea id="memo-content" class="form-textarea" rows="6" placeholder="메모 내용을 입력하세요" required></textarea>
                </div>
                <div class="form-group">
                    <label>포스트잇 색상</label>
                    <div class="color-selector">
                        <input type="radio" name="memo-bg-color" id="memo-bg-1" value="#FFF9C4" checked>
                        <label for="memo-bg-1" style="background: #FFF9C4;" title="연한 노란색"></label>
                        <input type="radio" name="memo-bg-color" id="memo-bg-2" value="#FCE4EC">
                        <label for="memo-bg-2" style="background: #FCE4EC;" title="연한 분홍색"></label>
                        <input type="radio" name="memo-bg-color" id="memo-bg-3" value="#E1F5FE">
                        <label for="memo-bg-3" style="background: #E1F5FE;" title="연한 하늘색"></label>
                        <input type="radio" name="memo-bg-color" id="memo-bg-4" value="#E8F5E9">
                        <label for="memo-bg-4" style="background: #E8F5E9;" title="연한 연두색"></label>
                        <input type="radio" name="memo-bg-color" id="memo-bg-5" value="#FFF3E0">
                        <label for="memo-bg-5" style="background: #FFF3E0;" title="연한 주황색"></label>
                        <input type="radio" name="memo-bg-color" id="memo-bg-6" value="#F3E5F5">
                        <label for="memo-bg-6" style="background: #F3E5F5;" title="연한 보라색"></label>
                        <input type="radio" name="memo-bg-color" id="memo-bg-7" value="#FFE0B2">
                        <label for="memo-bg-7" style="background: #FFE0B2;" title="연한 살구색"></label>
                        <input type="radio" name="memo-bg-color" id="memo-bg-8" value="#F1F8E9">
                        <label for="memo-bg-8" style="background: #F1F8E9;" title="연한 라임그린"></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>첨부파일</label>
                    <div class="file-upload-area">
                        <input type="file" id="memo-file" multiple style="display: none;">
                        <label for="memo-file" class="file-upload-label">
                            <i class="bx bx-cloud-upload"></i>
                            <span>파일 선택 또는 드래그</span>
                        </label>
                        <div class="file-preview" id="file-preview"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancel-memo">취소</button>
                <button class="btn-submit" id="submit-memo">등록</button>
            </div>
        </div>
    </div>

    <!-- 메모 상세보기 모달 -->
    <div class="modal-overlay" id="memo-view-modal" style="display: none;">
        <div class="memo-view-modal-content">
            <div class="modal-header">
                <h3 id="view-memo-title"></h3>
                <button class="modal-close" id="close-memo-view-modal">
                    <i class="bx bx-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- 읽기 모드 -->
                <div id="view-mode-read" class="view-mode">
                    <div class="view-memo-content" id="view-memo-content"></div>
                    <div class="view-memo-images" id="view-memo-images"></div>
                    <div class="view-memo-files" id="view-memo-files"></div>
                    <div class="view-memo-meta">
                        <div class="meta-item">
                            <i class="bx bx-user"></i>
                            <span id="view-memo-author"></span>
                        </div>
                        <div class="meta-item">
                            <i class="bx bx-time-five"></i>
                            <span id="view-memo-date"></span>
                        </div>
                    </div>
                    <div class="view-memo-actions">
                        <button class="btn-edit" id="view-edit-btn">
                            <i class="bx bx-edit"></i>
                            수정
                        </button>
                        <button class="btn-delete-view" id="view-delete-btn">
                            <i class="bx bx-trash"></i>
                            삭제
                        </button>
                    </div>
                </div>
                
                <!-- 수정 모드 -->
                <div id="view-mode-edit" class="view-mode" style="display: none;">
                    <div class="form-group">
                        <label for="view-edit-title">제목 <span style="color: var(--red);">*</span></label>
                        <input type="text" id="view-edit-title" class="form-input" placeholder="메모 제목을 입력하세요" maxlength="50" required>
                    </div>
                    <div class="form-group">
                        <label for="view-edit-content">내용 <span style="color: var(--red);">*</span></label>
                        <textarea id="view-edit-content" class="form-textarea" rows="6" placeholder="메모 내용을 입력하세요" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>포스트잇 색상</label>
                        <div class="color-selector">
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-1" value="#FFF9C4">
                            <label for="view-edit-bg-1" style="background: #FFF9C4;" title="연한 노란색"></label>
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-2" value="#FCE4EC">
                            <label for="view-edit-bg-2" style="background: #FCE4EC;" title="연한 분홍색"></label>
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-3" value="#E1F5FE">
                            <label for="view-edit-bg-3" style="background: #E1F5FE;" title="연한 하늘색"></label>
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-4" value="#E8F5E9">
                            <label for="view-edit-bg-4" style="background: #E8F5E9;" title="연한 연두색"></label>
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-5" value="#FFF3E0">
                            <label for="view-edit-bg-5" style="background: #FFF3E0;" title="연한 주황색"></label>
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-6" value="#F3E5F5">
                            <label for="view-edit-bg-6" style="background: #F3E5F5;" title="연한 보라색"></label>
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-7" value="#FFE0B2">
                            <label for="view-edit-bg-7" style="background: #FFE0B2;" title="연한 살구색"></label>
                            <input type="radio" name="view-edit-bg-color" id="view-edit-bg-8" value="#F1F8E9">
                            <label for="view-edit-bg-8" style="background: #F1F8E9;" title="연한 라임그린"></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>첨부파일</label>
                        <div class="file-upload-area">
                            <input type="file" id="view-edit-file" multiple style="display: none;">
                            <label for="view-edit-file" class="file-upload-label">
                                <i class="bx bx-cloud-upload"></i>
                                <span>파일 선택 또는 드래그</span>
                            </label>
                            <div class="file-preview" id="view-edit-file-preview"></div>
                        </div>
                    </div>
                    <div class="view-memo-actions">
                        <button class="btn-cancel-view" id="view-cancel-btn">
                            <i class="bx bx-x"></i>
                            취소
                        </button>
                        <button class="btn-save-view" id="view-save-btn">
                            <i class="bx bx-check"></i>
                            저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 과제 편집 모달 -->
    <div class="modal-overlay" id="assignment-modal" style="display: none;">
        <div class="assignment-modal-content">
            <div class="modal-header">
                <h3>과제 작성</h3>
                <button class="modal-close" id="close-assignment-modal">
                    <i class="bx bx-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="assignment-title-input">과제 제목</label>
                    <input type="text" id="assignment-title-input" class="form-input" placeholder="과제 제목을 입력하세요" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="assignment-text-input">과제 내용</label>
                    <textarea id="assignment-text-input" class="form-textarea" rows="8" placeholder="오늘의 과제 내용을 입력하세요"></textarea>
                </div>
                <div class="form-group">
                    <label>첨부파일</label>
                    <div class="file-upload-area">
                        <input type="file" id="assignment-file-input" multiple accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.txt" style="display: none;">
                        <label for="assignment-file-input" class="file-upload-label">
                            <i class="bx bx-cloud-upload"></i>
                            <span>파일 선택 또는 드래그 (이미지, PDF, 문서)</span>
                        </label>
                        <div class="file-preview" id="assignment-file-preview"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancel-assignment">취소</button>
                <button class="btn-submit" id="save-assignment">저장</button>
            </div>
        </div>
    </div>

    <!-- 과제 상세보기 모달 -->
    <div class="modal-overlay" id="assignment-view-modal" style="display: none;">
        <div class="memo-view-modal-content">
            <div class="modal-header">
                <h3 id="assignment-view-title"></h3>
                <button class="modal-close" id="close-assignment-view-modal">
                    <i class="bx bx-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="view-mode">
                    <div class="view-memo-content" id="assignment-view-text"></div>
                    <div class="view-memo-images" id="assignment-view-images"></div>
                    <div class="view-memo-files" id="assignment-view-files"></div>
                    <div class="view-memo-meta">
                        <div class="meta-item">
                            <i class="bx bx-user"></i>
                            <span id="assignment-view-author"></span>
                        </div>
                        <div class="meta-item">
                            <i class="bx bx-time-five"></i>
                            <span id="assignment-view-date"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialog.js -->
    <script src="dialog.js"></script>
    <script src="class-storage-utils.js"></script>
    <script src="activity-session.js"></script>
    
    <script>
        // 페이지 로드 및 포커스 시 확대/축소 값 고정 (75%)
        function fixZoom() {
            // document.body.style.zoom은 사용하지 않음 (브라우저 호환성)
            // viewport meta 태그로만 제어
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=0.75, maximum-scale=0.75, minimum-scale=0.75, user-scalable=no');
            }
        }
        
        // 페이지 로드 시
        window.addEventListener('load', fixZoom);
        
        // DOM 로드 시 즉시 실행
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fixZoom);
        } else {
            fixZoom();
        }
        
        // 포커스 시 (페이지 전환 후)
        window.addEventListener('focus', fixZoom);
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) {
                fixZoom();
            } else {
                fixZoom();
            }
        });
        
        // 히스토리 변경 감지 (뒤로/앞으로 가기)
        window.addEventListener('popstate', fixZoom);
        
        // 브랜드 클릭 시 홈으로 이동
        const navbarBrand = document.querySelector('.navbar-brand');
        if (navbarBrand) {
            navbarBrand.addEventListener('click', () => {
                window.location.href = 'main-session.html';
            });
        }

        // 로그아웃 처리
        const logoutBtn = document.querySelector('.logout-item');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userName');
                window.location.href = 'index.html';
            });
        }

        // 프로필 드롭다운
        const profileBtn = document.querySelector('.profile-btn');
        const profileDropdown = document.querySelector('.profile-dropdown');
        if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('click', (e) => {
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.style.display = 'none';
                }
            });
        }

        // 다크 모드 토글
        const switchMode = document.getElementById('switch-mode');
        if (switchMode) {
            // 저장된 다크 모드 설정 로드
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.body.classList.toggle('dark', isDarkMode);
            switchMode.checked = isDarkMode;

            // 다크 모드 토글 이벤트
            switchMode.addEventListener('change', (e) => {
                document.body.classList.toggle('dark', e.target.checked);
                localStorage.setItem('darkMode', e.target.checked);
            });
        }

        // Ask 세션으로 이동
        const navToAsk = document.getElementById('nav-to-ask');
        if (navToAsk) {
            navToAsk.addEventListener('click', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('sessionId');
                if (sessionId) {
                    window.location.href = `ask-session.html?sessionId=${sessionId}`;
                } else {
                    window.location.href = 'ask-session.html';
                }
            });
        }

        // Activity 세션으로 이동 (비활성화됨 - 현재 페이지)
        const navToActivity = document.getElementById('nav-to-activity');
        if (navToActivity) {
            navToActivity.addEventListener('click', (e) => {
                e.preventDefault();
            });
        }

        // ===================================
        // Sidebar - 완전히 새로 작성
        // ===================================
        
        // 사이드바 토글
        const sidebarToggle = document.getElementById('navbar-sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        
        if (sidebarToggle && sidebar) {
            // 저장된 사이드바 상태 불러오기
            const savedSidebarState = localStorage.getItem('sidebarCollapsed');
            if (savedSidebarState === 'true') {
                sidebar.classList.add('collapsed');
            }

            // 토글 이벤트
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            });

            // 반응형 처리
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                }
            });
        }

        // 사이드바 세션 목록 로드
        function loadSidebarSessions() {
            const sessionsList = document.getElementById('sessions-list');
            if (!sessionsList) return;

            // 클래스별 세션 목록 로드
            const classId = localStorage.getItem('selectedClassId') || 'default';
            const sessions = JSON.parse(localStorage.getItem(`sessions_${classId}`) || '[]');
            const urlParams = new URLSearchParams(window.location.search);
            const currentSessionId = urlParams.get('sessionId');

            if (sessions.length === 0) {
                sessionsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem 0; color: #999; font-size: 0.9rem;">
                        <i class="bx bx-calendar-x" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; display: block;"></i>
                        <p>아직 생성된 수업 게시물이 없습니다.</p>
                    </div>
                `;
                return;
            }

            // 최신순으로 정렬
            const sortedSessions = [...sessions].sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(b.date) - new Date(a.date);
                }
                return b.number - a.number;
            });

            sessionsList.innerHTML = sortedSessions.map(session => {
                const isActive = session.id === currentSessionId;
                const formattedDate = formatSessionDateForSidebar(session.date);
                return `
                    <div class="session-item ${isActive ? 'active' : ''}" data-session-id="${session.id}">
                        <div class="session-item-title">${escapeHtml(session.title)}</div>
                        <div class="session-item-meta">
                            <i class="bx bx-calendar"></i>
                            <span>${formattedDate} · ${session.number}차시</span>
                        </div>
                    </div>
                `;
            }).join('');

            // 세션 클릭 이벤트
            sessionsList.querySelectorAll('.session-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sessionId = item.getAttribute('data-session-id');
                    window.location.href = `activity-session.html?sessionId=${sessionId}`;
                });
            });
        }

        // 세션 날짜 포맷팅
        function formatSessionDateForSidebar(dateString) {
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 새로고침 버튼
        const refreshBtn = document.getElementById('refresh-sessions');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                loadSidebarSessions();
            });
        }

        // 초기 로드
        loadSidebarSessions();
    </script>
</body>
</html>

