<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=0.75, minimum-scale=0.75, user-scalable=no">
    <title>AI ClassBoard | Ask</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Lato:wght@300;400;700&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ask-session.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.1/wordcloud2.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="sidebar-top">
            <div class="sidebar-brand">
                <i class="bx bxs-graduation"></i>
                <span class="brand-name">ì„¸ì…˜ ëª©ë¡</span>
            </div>
            <button id="navbar-sidebar-toggle" class="navbar-sidebar-toggle-btn" aria-label="ì‚¬ì´ë“œë°” í† ê¸€">
                <i class="bx bx-chevron-left"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h3>ìˆ˜ì—… ê²Œì‹œë¬¼</h3>
                <button class="btn-refresh-sessions" id="refresh-sessions" title="ìƒˆë¡œê³ ì¹¨">
                    <i class="bx bx-refresh"></i>
                </button>
            </div>
            <div class="sessions-list" id="sessions-list">
                <!-- ì„¸ì…˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
        </div>
    </aside>

    <!-- Navbar -->
    <header id="navbar" class="session-navbar">
        <div class="navbar-brand">
            <i class="bx bxs-graduation"></i>
            <span class="brand-name">ClassBoard</span>
        </div>

        <!-- ì¤‘ì•™ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="navbar-center">
            <button class="nav-switch-btn" id="nav-to-activity" title="ê³µìœ  ë©”ëª¨ë³´ë“œë¡œ ì´ë™">
                <i class="bx bx-note"></i>
            </button>
            <button class="nav-switch-btn active" id="nav-to-ask" title="ì±„íŒ…/ì›Œë“œí´ë¼ìš°ë“œ (í˜„ì¬ í˜ì´ì§€)" disabled>
                <i class="bx bxs-chat"></i>
            </button>
        </div>

        <div class="navbar-right">
            <label class="dark-mode-toggle">
                <input type="checkbox" id="switch-mode" aria-label="ë‹¤í¬ ëª¨ë“œ ì „í™˜">
                <span class="switch-lm"></span>
            </label>

            <div class="profile">
                <button class="profile-btn" aria-label="í”„ë¡œí•„">
                    <i class="bx bxs-user-circle"></i>
                </button>
                <div class="profile-dropdown">
                    <div class="profile-info">
                        <div class="profile-info-header">
                            <i class="bx bxs-user-circle"></i>
                            <div>
                                <p class="profile-name" id="profile-name">ê´€ë¦¬ì</p>
                                <p class="profile-role" id="profile-role">êµì‚¬</p>
                            </div>
                        </div>
                    </div>
                    <div class="profile-divider"></div>
                    <a href="index.html" class="profile-menu-item">
                        <i class="bx bx-home"></i>
                        <span>í™ˆìœ¼ë¡œ</span>
                    </a>
                    <a href="#logout" class="profile-menu-item logout-item">
                        <i class="bx bx-log-out"></i>
                        <span>ë¡œê·¸ì•„ì›ƒ</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="ask-session-main">
        <div class="ask-session-container">
    <header class="ask-header">
        <h2 id="session-title">ğŸ’¬ ì‹¤ì‹œê°„ WordCloud Â· Chat</h2>
        <p id="session-description">ì±„íŒ… ë‚´ìš©ì´ ì‹¤ì‹œê°„ ì›Œë“œí´ë¼ìš°ë“œë¡œ ì‹œê°í™”ë˜ê³  í† ë¡ í•  ìˆ˜ ìˆëŠ” ê³µê°„ì…ë‹ˆë‹¤.</p>
    </header>

    <section class="ask-layout">
        <!-- WORDCLOUD -->
        <div class="wordcloud-panel">
            <h3>
                <i class="bx bx-cloud"></i>
                ì‹¤ì‹œê°„ WordCloud
            </h3>
            <canvas id="wordCloudCanvas"></canvas>
        </div>

                <!-- ë¦¬ì‚¬ì´ì € -->
                <div class="ask-layout-resizer" id="layout-resizer"></div>

        <!-- ì‹¤ì‹œê°„ ì±„íŒ… -->
        <div class="chat-panel">
            <h3>
                <i class="bx bxs-chat"></i>
                ì‹¤ì‹œê°„ ì±„íŒ…
            </h3>
            <div id="chatMessages" class="chat-window">
                <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
                <button id="sendChat">
                    <i class="bx bx-send"></i> ì „ì†¡
                </button>
            </div>
        </div>
    </section>
        </div>
    </main>

    <!-- Back to Home Button -->
    <a href="index.html" class="home-back-btn">
        <i class="bx bx-home"></i>
    </a>

    <script src="utils/common.js"></script>
    <script src="dialog.js"></script>
    <script src="ask-session.js"></script>
    <script src="ask-standalone.js"></script>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ë° í¬ì»¤ìŠ¤ ì‹œ í™•ëŒ€/ì¶•ì†Œ ê°’ ê³ ì • (75%)
        function fixZoom() {
            // document.body.style.zoomì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ë¸Œë¼ìš°ì € í˜¸í™˜ì„±)
            // viewport meta íƒœê·¸ë¡œë§Œ ì œì–´
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=0.75, maximum-scale=0.75, minimum-scale=0.75, user-scalable=no');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.addEventListener('load', fixZoom);
        
        // DOM ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fixZoom);
        } else {
            fixZoom();
        }
        
        // í¬ì»¤ìŠ¤ ì‹œ (í˜ì´ì§€ ì „í™˜ í›„)
        window.addEventListener('focus', fixZoom);
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) {
                fixZoom();
            } else {
                fixZoom();
            }
        });
        
        // íˆìŠ¤í† ë¦¬ ë³€ê²½ ê°ì§€ (ë’¤ë¡œ/ì•ìœ¼ë¡œ ê°€ê¸°)
        window.addEventListener('popstate', fixZoom);
        
        // ë¸Œëœë“œ í´ë¦­ ì‹œ í™ˆìœ¼ë¡œ ì´ë™
        const navbarBrand = document.querySelector('.navbar-brand');
        if (navbarBrand) {
            navbarBrand.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        const logoutBtn = document.querySelector('.logout-item');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userName');
                window.location.href = 'login.html';
            });
        }

        // í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´
        const profileBtn = document.querySelector('.profile-btn');
        const profileDropdown = document.querySelector('.profile-dropdown');
        if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('click', (e) => {
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.style.display = 'none';
                }
            });
        }

        // ë‹¤í¬ ëª¨ë“œ í† ê¸€
        const switchMode = document.getElementById('switch-mode');
        if (switchMode) {
            // ì €ì¥ëœ ë‹¤í¬ ëª¨ë“œ ì„¤ì • ë¡œë“œ
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.body.classList.toggle('dark', isDarkMode);
            switchMode.checked = isDarkMode;

            // ë‹¤í¬ ëª¨ë“œ í† ê¸€ ì´ë²¤íŠ¸
            switchMode.addEventListener('change', (e) => {
                document.body.classList.toggle('dark', e.target.checked);
                localStorage.setItem('darkMode', e.target.checked);
            });
        }

        // í”„ë¡œí•„ ì •ë³´ ë¡œë“œ
        const profileName = document.getElementById('profile-name');
        const profileRole = document.getElementById('profile-role');
        if (profileName) {
            const userName = localStorage.getItem('userName');
            if (userName) {
                profileName.textContent = userName;
            }
        }
        if (profileRole) {
            const userRole = localStorage.getItem('userRole');
            if (userRole) {
                profileRole.textContent = userRole === 'admin' ? 'êµì‚¬' : 'í•™ìƒ';
            }
        }

        // ì„¸ì…˜ ì •ë³´ ë¡œë“œ
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sessionId');
        if (sessionId) {
            const sessions = (window.AppUtils && AppUtils.getStoredArray) ? AppUtils.getStoredArray('sessions') : JSON.parse(localStorage.getItem('sessions') || '[]');
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                const sessionTitle = document.getElementById('session-title');
                const sessionDescription = document.getElementById('session-description');
                if (sessionTitle) {
                    sessionTitle.textContent = `ğŸ’¬ ${session.title}`;
                }
                if (sessionDescription) {
                    sessionDescription.textContent = `${session.author || 'ê´€ë¦¬ì'}ë‹˜ì´ ì‘ì„±í•œ ì±„íŒ…ë°©ì…ë‹ˆë‹¤.`;
                }
            }
        }

        // Activity ì„¸ì…˜ìœ¼ë¡œ ì´ë™
        const navToActivity = document.getElementById('nav-to-activity');
        if (navToActivity) {
            navToActivity.addEventListener('click', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('sessionId');
                if (sessionId) {
                    window.location.href = `activity-session.html?sessionId=${sessionId}`;
                } else {
                    window.location.href = 'activity-session.html';
                }
            });
        }

        // Ask ì„¸ì…˜ìœ¼ë¡œ ì´ë™ (ë¹„í™œì„±í™”ë¨ - í˜„ì¬ í˜ì´ì§€)
        const navToAsk = document.getElementById('nav-to-ask');
        if (navToAsk) {
            navToAsk.addEventListener('click', (e) => {
                e.preventDefault();
            });
        }

        // ===================================
        // Sidebar - ì™„ì „íˆ ìƒˆë¡œ ì‘ì„±
        // ===================================
        
        // ì‚¬ì´ë“œë°” í† ê¸€
        const sidebarToggle = document.getElementById('navbar-sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        
        if (sidebarToggle && sidebar) {
            // ì €ì¥ëœ ì‚¬ì´ë“œë°” ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedSidebarState = localStorage.getItem('sidebarCollapsed');
            if (savedSidebarState === 'true') {
                sidebar.classList.add('collapsed');
            }

            // í† ê¸€ ì´ë²¤íŠ¸
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            });

            // ë°˜ì‘í˜• ì²˜ë¦¬
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                }
            });
        }

        // ì‚¬ì´ë“œë°” ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
        function loadSidebarSessions() {
            const sessionsList = document.getElementById('sessions-list');
            if (!sessionsList) return;

            const sessions = (window.AppUtils && AppUtils.getStoredArray) ? AppUtils.getStoredArray('sessions') : JSON.parse(localStorage.getItem('sessions') || '[]');
            const urlParams = new URLSearchParams(window.location.search);
            const currentSessionId = urlParams.get('sessionId');

            if (sessions.length === 0) {
                sessionsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem 0; color: #999; font-size: 0.9rem;">
                        <i class="bx bx-calendar-x" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; display: block;"></i>
                        <p>ì•„ì§ ìƒì„±ëœ ìˆ˜ì—… ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedSessions = [...sessions].sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(b.date) - new Date(a.date);
                }
                return b.number - a.number;
            });

            sessionsList.innerHTML = sortedSessions.map(session => {
                const isActive = session.id === currentSessionId;
                const formattedDate = formatSessionDateForSidebar(session.date);
                return `
                    <div class="session-item ${isActive ? 'active' : ''}" data-session-id="${session.id}">
                        <div class="session-item-title">${escapeHtml(session.title)}</div>
                        <div class="session-item-meta">
                            <i class="bx bx-calendar"></i>
                            <span>${formattedDate} Â· ${session.number}ì°¨ì‹œ</span>
                        </div>
                    </div>
                `;
            }).join('');

            // ì„¸ì…˜ í´ë¦­ ì´ë²¤íŠ¸
            sessionsList.querySelectorAll('.session-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sessionId = item.getAttribute('data-session-id');
                    // í˜„ì¬ í˜ì´ì§€ì— ë§ê²Œ ì´ë™
                    if (window.location.pathname.includes('ask-session.html')) {
                        window.location.href = `ask-session.html?sessionId=${sessionId}`;
                    } else {
                        window.location.href = `activity-session.html?sessionId=${sessionId}`;
                    }
                });
            });
        }

        // ì„¸ì…˜ ë‚ ì§œ í¬ë§·íŒ…
        function formatSessionDateForSidebar(dateString) {
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }

        // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        const refreshBtn = document.getElementById('refresh-sessions');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                loadSidebarSessions();
            });
        }

        // ì´ˆê¸° ë¡œë“œ
        loadSidebarSessions();

        // ===================================
        // ë ˆì´ì•„ì›ƒ ë¦¬ì‚¬ì´ì € ê¸°ëŠ¥ (ì™„ë²½í•œ êµ¬í˜„)
        // ===================================
        const resizer = document.getElementById('layout-resizer');
        const layout = document.querySelector('.ask-layout');
        let isResizing = false;
        let startX = 0;
        let startWidthLeft = 0;
        let startWidthRight = 0;

        if (resizer && layout) {
            // ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                
                // í˜„ì¬ ë ˆì´ì•„ì›ƒ í¬ê¸° ì €ì¥
                const layoutRect = layout.getBoundingClientRect();
                const wordcloudPanel = document.querySelector('.wordcloud-panel');
                const chatPanel = document.querySelector('.chat-panel');
                
                if (wordcloudPanel && chatPanel) {
                    startWidthLeft = wordcloudPanel.getBoundingClientRect().width;
                    startWidthRight = chatPanel.getBoundingClientRect().width;
                }
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                resizer.style.background = 'var(--blue)';
                
                e.preventDefault();
                e.stopPropagation();
            });

            // ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const layoutRect = layout.getBoundingClientRect();
                const diffX = e.clientX - startX;
                const totalWidth = layoutRect.width;
                const resizerWidth = 5;
                const availableWidth = totalWidth - resizerWidth;
                
                // ìƒˆë¡œìš´ ë„ˆë¹„ ê³„ì‚°
                let newWidthLeft = startWidthLeft + diffX;
                let newWidthRight = startWidthRight - diffX;
                
                // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ (ê° íŒ¨ë„ì€ ìµœì†Œ 250px, ìµœëŒ€ availableWidth - 250px)
                const minPanelWidth = 250;
                const maxPanelWidth = availableWidth - minPanelWidth;
                
                if (newWidthLeft < minPanelWidth) {
                    newWidthLeft = minPanelWidth;
                    newWidthRight = availableWidth - newWidthLeft;
                } else if (newWidthLeft > maxPanelWidth) {
                    newWidthLeft = maxPanelWidth;
                    newWidthRight = availableWidth - newWidthLeft;
                } else if (newWidthRight < minPanelWidth) {
                    newWidthRight = minPanelWidth;
                    newWidthLeft = availableWidth - newWidthRight;
                }
                
                // í¼ì„¼íŠ¸ë¡œ ë³€í™˜
                const percentLeft = (newWidthLeft / availableWidth) * 100;
                const percentRight = (newWidthRight / availableWidth) * 100;
                
                // ê·¸ë¦¬ë“œ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
                layout.style.gridTemplateColumns = `${percentLeft}% 5px ${percentRight}%`;
            });

            // ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    resizer.style.background = '';
                    
                    // WordCloud ìì—°ìŠ¤ëŸ½ê²Œ ì¬ë Œë”ë§ (í¬ê¸° ë³€ê²½ í›„)
                    // í˜ì´ë“œ ì•„ì›ƒ -> ì¬ë Œë”ë§ -> í˜ì´ë“œ ì¸
                    const canvas = document.getElementById('wordCloudCanvas');
                    if (canvas && typeof renderWordCloud === 'function') {
                        if (canvas.style.opacity !== '0') {
                            canvas.style.transition = 'opacity 0.3s ease-out';
                            canvas.style.opacity = '0.3';
                            
                            setTimeout(() => {
                                renderWordCloud();
                                canvas.style.transition = 'opacity 0.5s ease-in';
                                setTimeout(() => {
                                    canvas.style.opacity = '1';
                                }, 50);
                            }, 200);
                        } else {
                            setTimeout(() => {
                                renderWordCloud();
                            }, 150);
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
